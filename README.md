# MOS/NOS Backend Playground

This repository contains a Next.js workspace that targets the MOS/NOS interoperability specifications. The domain layer models core data classes (personnes physiques, professionnels, autorisations, capacités, dispositifs d'authentification, etc.) and exposes TypeScript serializers to keep MongoDB documents aligned with the MOS nomenclatures.

---

## Prerequisites

1. **Node.js 20+** (or a recent LTS). Install dependencies once:
   ```bash
   npm install
   ```
2. **MongoDB database** accessible from your workstation. Configure credentials in `.env`:
   ```env
   MONGODB_URI=mongodb+srv://<user>:<password>@cluster.example.mongodb.net/?retryWrites=true&w=majority
   MONGODB_DB=la_clinique
   ```
   The seed script uses these variables through `src/config/env.ts`.

---

## Populating Sample MOS Data

A TypeScript seeding script in `scripts/seed.ts` inserts a coherent dataset that relies on the NOS mapping defined in `src/domain/nos.ts` (civilités, rôles, usages de certificats, etc.).

Run it with:
```bash
npm run seed
```

What the script does:
- Flushes previous demo data whose metadata was tagged as generated by the seeder.
- Inserts a **personne physique** (Jean Dupont) referencing NOS codes (civilité, sexe, profession).
- Adds a **dispositif d'authentification** (CPS card + certificate) bound to the professional’s exercise.
- Creates a **professionnel** record embedding the dispositif, a **personne prise en charge**, and an **autorisation** with capacité d’accueil.

Every inserted document carries a `metadonnee.commentaire` referencing `seed-script` so you can identify or purge the sample rows later.

To remove the dataset, re-run `npm run seed` (the script deletes existing tagged entries before re-inserting) or execute in `mongosh`:
```javascript
db.professionnels.deleteMany({ "metadonnee.commentaire.valeur": /seed-script/ })
```

---

## Visualising the Database (auth focus)

### MongoDB Compass (recommended for evaluations)
1. Open Compass and connect with your `MONGODB_URI`.
2. Select the `la_clinique` database and explore the following collections:
   - `professionnels`: check the `exercicesProfessionnels.dispositifsAuthentification` array. The embedded CPS card and certificate demonstrate the authentication workflow.
   - `dispositifsAuthentification`: standalone store of cards/certificates (useful for cross-checking or building lookups).
   - `autorisations` and `personnesPhysiques` for supporting context.
3. Use the **Schema** tab to generate quick summaries. For example, in `dispositifsAuthentification`, you can see the fields `cartes.typeCarte.valeur`, `certificats.usage.valeur`, etc., all mapped to NOS codes.

### CLI inspection (quick checks)
```bash
mongosh "$MONGODB_URI" --eval '
use la_clinique;
db.dispositifsAuthentification.find({ "cartes.numeroCarte.valeur": "99887766" }).pretty();
'
```
This command outputs the authentication dataset in JSON—handy for screenshots or to share raw payloads with your professor.

### Building a custom view
Because serializers convert Mongo documents into DTO-like structures, you can rapidly expose them in a Next.js page or API route:
```ts
const collection = await getDispositifAuthentificationCollection();
const docs = await collection.find({}).toArray();
const dtos = docs.map(DispositifAuthentificationSerializer.fromDocument);
```
Render the `dtos` in a table to demonstrate the CPS cards, certificate metadata (usage, domaine, dates), and associated NOS nomenclatures.

---

## Project Scripts
- `npm run dev` – start Next.js.
- `npm run lint` – lint the codebase.
- `npm run seed` – (re)generate the MOS mock dataset described above.

---

## Nomenclature Mapping Reminder
`src/domain/nos.ts` centralises the MOS/NOS mapping used by the seeder. Extend this file with additional codes from [esante.gouv.fr](https://esante.gouv.fr/interoperabilite/mos-nos/nos) as your domain models grow. Then reuse `nosCode(domain, key)` everywhere you build MOS objects to keep code values and libellés consistent.

---

This is the MONGODB_URI : mongodb+srv://angekonian2_db_user:8ypiOtPQM6ITEHH6@cluster0.gaunyrt.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0

Happy hacking! Populate, inspect, and iteratively enrich the MOS structures to match your coursework requirements.
